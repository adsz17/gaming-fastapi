<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crash MVP - Auth + Balance</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, sans-serif; margin:0; background:#0f1220; color:#eaeaf2; }
    header { padding:16px; background:#141833; }
    .wrap { padding:16px; max-width:960px; margin:0 auto; }
    .grid { display:grid; gap:16px; grid-template-columns: 1fr; }
    .card { background:#10142a; border-radius:14px; padding:16px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    input, button {
      padding: 10px 12px; border-radius: 10px; border: 1px solid #2a2f55;
      background: #1b2045; color: #fff; outline: none;
    }
    button { cursor: pointer; }
    .pill { background:#0b0e1d; border:1px solid #2a2f55; border-radius:999px; padding:6px 10px; }
    .log { margin-top:12px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      background:#0b0e1d; padding:12px; border-radius:8px; height:180px; overflow:auto; }
    canvas { border-radius:12px; }
    .meta { font-size:12px; opacity:.8; margin-top:8px; word-break: break-all; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/8.2.5/pixi.min.js"></script>
  <script src="auth.js"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Crash MVP</h1>
      <p>Provably fair + JWT + Balance</p>
    </div>
  </header>

  <div class="wrap grid">
    <!-- Auth -->
    <div class="card">
      <div class="row">
        <b>Auth</b>
        <span class="pill" id="status">Desconectado</span>
        <span class="pill" id="balance">Balance: -</span>
        <button id="btnLogout">Logout</button>
      </div>
    </div>

    <!-- Juego -->
    <div class="card">
      <div class="row">
        <label>Apuesta</label>
        <input id="bet" type="number" step="0.01" value="1.00"/>
        <label>Client Seed</label>
        <input id="clientSeed" type="text" value="demo-seed"/>
        <button id="playBtn">Jugar</button>
        <span id="health"></span>
      </div>
      <div class="meta" id="meta"></div>
      <div id="stage" style="margin-top: 16px;"></div>
      <div class="log" id="log"></div>
    </div>
  </div>

<script>
const statusEl = document.getElementById("status");
const balEl = document.getElementById("balance");
const btnLogout = document.getElementById("btnLogout");

const logEl = document.getElementById("log");
const stageEl = document.getElementById("stage");
const betEl = document.getElementById("bet");
const csEl = document.getElementById("clientSeed");
const healthEl = document.getElementById("health");
const metaEl = document.getElementById("meta");
const playBtn = document.getElementById("playBtn");

if(!isAuthed()) location.href = "login.html";

function log(s){
  const t = new Date().toLocaleTimeString();
  logEl.innerHTML = `[${t}] ${s}<br/>` + logEl.innerHTML;
}

async function health(){
  try{
    const r = await fetch(API_BASE + "/health");
    const j = await r.json();
    healthEl.textContent = "server_seed_hash | nonce: " + j.nonce;
    metaEl.textContent = j.server_seed_hash;
  }catch(e){ healthEl.textContent = "offline"; }
}
setInterval(health, 3000); health();

async function refreshMe(){
  statusEl.textContent = "Conectado";
  try{
    const r = await fetch(API_BASE + "/account", {
      headers: { Authorization: "Bearer " + getToken() }
    });
    if(r.ok){
      const j = await r.json();
      balEl.textContent = "Balance: " + j.balance.toFixed?.(2) ?? j.balance;
    }else{
      statusEl.textContent = "Token inválido";
      clearToken();
      location.href = "login.html";
    }
  }catch(e){
    statusEl.textContent = "Error";
  }
}
refreshMe();

btnLogout.onclick = () => { clearToken(); location.href = "login.html"; };

// ---- PIXI ----
const app = new PIXI.Application();
await app.init({ width: 960, height: 320, background: "#0b0e1d", antialias: true });
stageEl.appendChild(app.canvas);

const rail = new PIXI.Graphics().roundRect(20, 140, 920, 10, 5).fill({color: 0x2e3355});
app.stage.addChild(rail);

let bar = new PIXI.Graphics().roundRect(20, 140, 0, 10, 5).fill({color: 0x6ee7ff});
app.stage.addChild(bar);

const head = new PIXI.Graphics().circle(20, 145, 7).fill({color: 0x6ee7ff});
app.stage.addChild(head);

const label = new PIXI.Text({ text: "x1.00", style: { fill: "#eaeaf2", fontSize: 32, fontWeight: "bold" } });
label.x = 20; label.y = 90; app.stage.addChild(label);

function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }
let currentAnim = null;
function resetBar(){
  bar.clear().roundRect(20, 140, 0, 10, 5).fill({color: 0x6ee7ff});
  head.clear().circle(20, 145, 7).fill({color: 0x6ee7ff});
  label.text = "x1.00";
}

function animateToMultiplier(mult){
  if (currentAnim) app.ticker.remove(currentAnim);
  resetBar();
  const maxW = 920, maxM = 100.0;
  const targetW = Math.min(maxW, (mult / maxM) * maxW);
  const durationMs = 2000;
  const start = performance.now();
  currentAnim = () => {
    const t = Math.min(1, (performance.now() - start) / durationMs);
    const p = easeOutCubic(t);
    const w = targetW * p;
    bar.clear().roundRect(20, 140, w, 10, 5).fill({color: 0x6ee7ff});
    head.clear().circle(20 + w, 145, 7).fill({color: 0x6ee7ff});
    label.text = "x" + (1 + (mult - 1) * p).toFixed(2);
    if (t >= 1) app.ticker.remove(currentAnim);
  };
  app.ticker.add(currentAnim);
}

playBtn.onclick = async () => {
  if(!isAuthed()) return alert("Primero logeate");
  const bet = parseFloat(betEl.value);
  const client_seed = csEl.value || "demo-seed";
  if (!(bet > 0)) return alert("Bet > 0");

  try{
    const r = await fetch(API_BASE + "/round", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + getToken()
      },
      body: JSON.stringify({ bet, client_seed })
    });
    const j = await r.json();
    if (r.ok){
      log(`ROUND #${j.round_id} → multiplier x${j.multiplier} | payout ${j.payout} | balance ${j.new_balance}`);
      animateToMultiplier(j.multiplier);
      balEl.textContent = "Balance: " + Number(j.new_balance).toFixed(2);
    } else {
      log("Error: " + JSON.stringify(j));
    }
  }catch(e){
    console.error(e); log("Network error");
  }
};
</script>
</body>
</html>
